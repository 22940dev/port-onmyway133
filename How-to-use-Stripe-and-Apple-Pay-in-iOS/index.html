<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Issue #219  iOS Integration Setting Up Apple Pay Requirements Apple Pay  Show basic add card in iOS12345678910111213141516171819202122232425import UIKitimport Stripefinal class MainController: UIViewC">
<meta name="keywords" content="swift,iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="How to use Stripe and Apple Pay in iOS">
<meta property="og:url" content="https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/index.html">
<meta property="og:site_name" content="onmyway133">
<meta property="og:description" content="Issue #219  iOS Integration Setting Up Apple Pay Requirements Apple Pay  Show basic add card in iOS12345678910111213141516171819202122232425import UIKitimport Stripefinal class MainController: UIViewC">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-08-14T08:58:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="How to use Stripe and Apple Pay in iOS">
<meta name="twitter:description" content="Issue #219  iOS Integration Setting Up Apple Pay Requirements Apple Pay  Show basic add card in iOS12345678910111213141516171819202122232425import UIKitimport Stripefinal class MainController: UIViewC">
    
    
        
          
              <link rel="shortcut icon" href="/images/icons96.jpeg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/icons96.jpeg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/icons96.jpeg">
          
        
    
    <!-- title -->
    <title>How to use Stripe and Apple Pay in iOS</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/speaking/">Speaking</a></li>
         
          <li><a href="/opensource/">Open Source</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/How-to-make-simple-search-box-in-iOS/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/How-to-use-Sonarqube-in-Swift-projects/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&text=How to use Stripe and Apple Pay in iOS"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&is_video=false&description=How to use Stripe and Apple Pay in iOS"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=How to use Stripe and Apple Pay in iOS&body=Check out this article: https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&name=How to use Stripe and Apple Pay in iOS&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Show-basic-add-card-in-iOS"><span class="toc-number">1.</span> <span class="toc-text">Show basic add card in iOS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generate-ephemeral-key"><span class="toc-number">2.</span> <span class="toc-text">Generate ephemeral key</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backend-in-Go"><span class="toc-number">2.1.</span> <span class="toc-text">Backend in Go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS-client"><span class="toc-number">2.2.</span> <span class="toc-text">iOS client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handle-charge"><span class="toc-number">3.</span> <span class="toc-text">Handle charge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backend-in-Go-1"><span class="toc-number">3.1.</span> <span class="toc-text">Backend in Go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS-client-1"><span class="toc-number">3.2.</span> <span class="toc-text">iOS client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Token-from-card"><span class="toc-number">4.</span> <span class="toc-text">Token from card</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payment-options-and-shipping-view-controllers"><span class="toc-number">5.</span> <span class="toc-text">Payment options and shipping view controllers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Register-merchant-Id-and-Apple-Pay-certificate"><span class="toc-number">6.</span> <span class="toc-text">Register merchant Id and Apple Pay certificate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Use-Apple-Pay"><span class="toc-number">7.</span> <span class="toc-text">Use Apple Pay</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Go-backend"><span class="toc-number">7.1.</span> <span class="toc-text">Go backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS-client-2"><span class="toc-number">7.2.</span> <span class="toc-text">iOS client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Showing-Apple-Pay-option"><span class="toc-number">8.</span> <span class="toc-text">Showing Apple Pay option</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requestPayment-not-showing-UI"><span class="toc-number">9.</span> <span class="toc-text">requestPayment not showing UI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payment-options"><span class="toc-number">10.</span> <span class="toc-text">Payment options</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Change-selected-payment-option"><span class="toc-number">11.</span> <span class="toc-text">Change selected payment option</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        How to use Stripe and Apple Pay in iOS
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">onmyway133</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-04-30T09:12:12.000Z" itemprop="datePublished">2019-04-30</time>
        
        (Updated: <time datetime="2019-08-14T08:58:44.000Z" itemprop="dateModified">2019-08-14</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/iOS/">iOS</a>, <a class="tag-link" href="/tags/swift/">swift</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><strong>Issue <a href="https://github.com/onmyway133/blog/issues/219" target="_blank" rel="noopener">#219</a></strong></p>
<ul>
<li><a href="https://stripe.com/docs/mobile/ios" target="_blank" rel="noopener">iOS Integration</a></li>
<li><a href="https://developer.apple.com/documentation/passkit/apple_pay/setting_up_apple_pay_requirements" target="_blank" rel="noopener">Setting Up Apple Pay Requirements</a></li>
<li><a href="https://stripe.com/docs/apple-pay" target="_blank" rel="noopener">Apple Pay</a></li>
</ul>
<h2 id="Show-basic-add-card-in-iOS"><a href="#Show-basic-add-card-in-iOS" class="headerlink" title="Show basic add card in iOS"></a>Show basic add card in iOS</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Stripe</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">showPayment</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> addCardViewController = <span class="type">STPAddCardViewController</span>()</span><br><span class="line">        addCardViewController.delegate = <span class="keyword">self</span></span><br><span class="line">        <span class="keyword">let</span> navigationController = <span class="type">UINavigationController</span>(rootViewController: addCardViewController)</span><br><span class="line"></span><br><span class="line">        present(navigationController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MainController</span>: <span class="title">STPAddCardViewControllerDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addCardViewControllerDidCancel</span><span class="params">(<span class="number">_</span> addCardViewController: STPAddCardViewController)</span></span> &#123;</span><br><span class="line">        dismiss(animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">addCardViewController</span><span class="params">(<span class="number">_</span> addCardViewController: STPAddCardViewController, didCreateToken token: STPToken, completion: @escaping STPErrorBlock)</span></span> &#123;</span><br><span class="line">        <span class="number">_</span> = token.tokenId</span><br><span class="line">        completion(<span class="literal">nil</span>)</span><br><span class="line">        dismiss(animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Generate-ephemeral-key"><a href="#Generate-ephemeral-key" class="headerlink" title="Generate ephemeral key"></a>Generate ephemeral key</h2><p><a href="https://stripe.com/docs/mobile/ios/standard#ephemeral-key" target="_blank" rel="noopener">https://stripe.com/docs/mobile/ios/standard#ephemeral-key</a></p>
<blockquote>
<p>In order for our prebuilt UI elements to function, you’ll need to provide them with an ephemeral key, a short-lived API key with restricted API access. You can think of an ephemeral key as a session, authorizing the SDK to retrieve and update a specific Customer object for the duration of the session.</p>
</blockquote>
<h3 id="Backend-in-Go"><a href="#Backend-in-Go" class="headerlink" title="Backend in Go"></a>Backend in Go</h3><p><a href="https://github.com/stripe/stripe-go" target="_blank" rel="noopener">https://github.com/stripe/stripe-go</a></p>
<p>Need a secret key by going to <code>Stripe dashboard -&gt; Developers -&gt; API keys -&gt; Secret key</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stripe.Key = &quot;sk_key&quot;</span><br></pre></td></tr></table></figure>

<p>Need customer id. We can manually create one in <code>Stripe dashboard -&gt; Customers</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"github.com/stripe/stripe-go"</span></span><br><span class="line">    <span class="string">"github.com/stripe/stripe-go/ephemeralkey"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	stripe.Key = <span class="string">"sk_test_mM2MkqO61n7vvbVRfeYmBgWm00Si2PtWab"</span></span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">"/ephemeral_keys"</span>, generateEphemeralKey)</span><br><span class="line">  	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    	<span class="built_in">panic</span>(err)</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> EphemeralKeysRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">    ApiVersion <span class="keyword">string</span> <span class="string">`json:"api_version"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateEphemeralKey</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	customerId := <span class="string">"cus_Eys6aeP5xR89ab"</span></span><br><span class="line"></span><br><span class="line">	decoder := json.NewDecoder(r.Body)</span><br><span class="line">    <span class="keyword">var</span> t EphemeralKeysRequest</span><br><span class="line">    err := decoder.Decode(&amp;t)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stripeVersion := t.ApiVersion</span><br><span class="line">    <span class="keyword">if</span> stripeVersion == <span class="string">""</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">"Stripe-Version not found\n"</span>)</span><br><span class="line">        w.WriteHeader(<span class="number">400</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    params := &amp;stripe.EphemeralKeyParams&#123;</span><br><span class="line">        Customer: stripe.String(customerId),</span><br><span class="line">        StripeVersion: stripe.String(stripeVersion),</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    key, err := ephemeralkey.New(params)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">"Stripe bindings call failed, %v\n"</span>, err)</span><br><span class="line">        w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    w.Write(key.RawJSON)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="iOS-client"><a href="#iOS-client" class="headerlink" title="iOS client"></a>iOS client</h3><p>Networking client uses <a href="https://github.com/onmyway133/blog/issues/222" target="_blank" rel="noopener">How to make simple networking client in Swift</a></p>
<p>Need an object that conforms to <code>STPCustomerEphemeralKeyProvider</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EphemeralKeyClient</span>: <span class="title">NSObject</span>, <span class="title">STPCustomerEphemeralKeyProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> client = <span class="type">NetworkClient</span>(baseUrl: <span class="type">URL</span>(string: <span class="string">"http://localhost:8080"</span>)!)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">createCustomerKey</span><span class="params">(withAPIVersion apiVersion: String, completion: @escaping STPJSONResponseCompletionBlock)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> options = <span class="type">Options</span>()</span><br><span class="line">        options.httpMethod = .post</span><br><span class="line">        options.path = <span class="string">"ephemeral_keys"</span></span><br><span class="line">        options.parameters = [</span><br><span class="line">            <span class="string">"api_version"</span>: apiVersion</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        client.makeJson(options: options, completion: &#123; result <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">switch</span> result &#123;</span><br><span class="line">            <span class="keyword">case</span> .success(<span class="keyword">let</span> json):</span><br><span class="line">                completion(json, <span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">case</span> .failure(<span class="keyword">let</span> error):</span><br><span class="line">                completion(<span class="literal">nil</span>, error)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Setting up <code>STPCustomerContext</code> and <code>STPPaymentContext</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> client = <span class="type">EphemeralKeyClient</span>()</span><br><span class="line">    <span class="keyword">let</span> customerContext: <span class="type">STPCustomerContext</span></span><br><span class="line">    <span class="keyword">let</span> paymentContext: <span class="type">STPPaymentContext</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">self</span>.customerContext = <span class="type">STPCustomerContext</span>(keyProvider: client)</span><br><span class="line">        <span class="keyword">self</span>.paymentContext = <span class="type">STPPaymentContext</span>(customerContext: customerContext)</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(nibName: <span class="literal">nil</span>, bundle: <span class="literal">nil</span>)</span><br><span class="line">        paymentContext.delegate = <span class="keyword">self</span></span><br><span class="line">        paymentContext.hostViewController = <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">"init(coder:) has not been implemented"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        paymentContext.presentShippingViewController()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Handle-charge"><a href="#Handle-charge" class="headerlink" title="Handle charge"></a>Handle charge</h2><p><a href="https://stripe.com/docs/charges" target="_blank" rel="noopener">https://stripe.com/docs/charges</a></p>
<h3 id="Backend-in-Go-1"><a href="#Backend-in-Go-1" class="headerlink" title="Backend in Go"></a>Backend in Go</h3><p>If we use <code>stripe_id</code> from card, which has the form of <code>card_xxx</code>, we need to include <code>customer</code> info</p>
<p>If we use <code>token</code>, which has the form <code>tok_xxx</code>, then no need for <code>customer</code> info</p>
<p>From <code>STPPaymentResult</code></p>
<blockquote>
<p>When you’re using <code>STPPaymentContext</code> to request your user’s payment details, this is the object that will be returned to your application when they’ve successfully made a payment. It currently just contains a <code>source</code>, but in the future will include any relevant metadata as well. You should pass <code>source.stripeID</code> to your server, and call the charge creation endpoint. This assumes you are charging a Customer, so you should specify the <code>customer</code> parameter to be that customer’s ID and the <code>source</code> parameter to the value returned here. For more information, see <a href="https://stripe.com/docs/api#create_charge" target="_blank" rel="noopener">https://stripe.com/docs/api#create_charge</a></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"github.com/stripe/stripe-go/charge"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	stripe.Key = <span class="string">"sk_test_mM2MkqO61n7vvbVRfeYmBgWm00Si2PtWab"</span></span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">"/request_charge"</span>, handleCharge)</span><br><span class="line">  	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    	<span class="built_in">panic</span>(err)</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> customerId = <span class="string">"cus_Eys6aeP5xR89ab"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PaymentResult <span class="keyword">struct</span> &#123;</span><br><span class="line">    StripeId <span class="keyword">string</span> <span class="string">`json:"stripe_id"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleCharge</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	decoder := json.NewDecoder(r.Body)</span><br><span class="line">    <span class="keyword">var</span> t PaymentResult</span><br><span class="line">    err := decoder.Decode(&amp;t)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    params := &amp;stripe.ChargeParams&#123;</span><br><span class="line">        Amount:      stripe.Int64(<span class="number">150</span>),</span><br><span class="line">        Currency:    stripe.String(<span class="keyword">string</span>(stripe.CurrencyUSD)),</span><br><span class="line">		Description: stripe.String(<span class="string">"Charge from my Go backend"</span>),</span><br><span class="line">		Customer: stripe.String(customerId),</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">	params.SetSource(t.StripeId)</span><br><span class="line">    ch, err := charge.New(params)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"Could not process payment: %v"</span>, err)</span><br><span class="line">		fmt.Println(ch)</span><br><span class="line">		w.WriteHeader(<span class="number">400</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	w.WriteHeader(<span class="number">200</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="iOS-client-1"><a href="#iOS-client-1" class="headerlink" title="iOS client"></a>iOS client</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> client = <span class="type">NetworkClient</span>(baseUrl: <span class="type">URL</span>(string: <span class="string">"http://192.168.210.219:8080"</span>)!)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">requestCharge</span><span class="params">(source: STPSourceProtocol, completion: @escaping <span class="params">(Result&lt;<span class="params">()</span></span></span></span>, <span class="type">Error</span>&gt;) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> options = <span class="type">Options</span>()</span><br><span class="line">        options.httpMethod = .post</span><br><span class="line">        options.path = <span class="string">"request_charge"</span></span><br><span class="line">        options.parameters = [</span><br><span class="line">            <span class="string">"stripe_id"</span>: source.stripeID</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        client.makeJson(options: options, completion: &#123; result <span class="keyword">in</span></span><br><span class="line">            completion(result.<span class="built_in">map</span>(&#123; <span class="number">_</span> <span class="keyword">in</span> () &#125;))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">paymentContext.requestPayment()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MainController</span>: <span class="title">STPPaymentContextDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">paymentContext</span><span class="params">(<span class="number">_</span> paymentContext: STPPaymentContext, didCreatePaymentResult paymentResult: STPPaymentResult, completion: @escaping STPErrorBlock)</span></span> &#123;</span><br><span class="line">        client.requestCharge(source: paymentResult.source, completion: &#123; result <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">switch</span> result &#123;</span><br><span class="line">            <span class="keyword">case</span> .success:</span><br><span class="line">                completion(<span class="literal">nil</span>)</span><br><span class="line">            <span class="keyword">case</span> .failure(<span class="keyword">let</span> error):</span><br><span class="line">                completion(error)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Token-from-card"><a href="#Token-from-card" class="headerlink" title="Token from card"></a>Token from card</h2><p>Use <code>STPAPIClient.shared().createToken</code> to get token from card <a href="https://stripe.com/docs/mobile/ios/custom#collecting-card-details" target="_blank" rel="noopener">https://stripe.com/docs/mobile/ios/custom#collecting-card-details</a></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cardParams = <span class="type">STPCardParams</span>()</span><br><span class="line">cardParams.number = <span class="string">"4242424242424242"</span></span><br><span class="line">cardParams.expMonth = <span class="number">10</span></span><br><span class="line">cardParams.expYear = <span class="number">2021</span></span><br><span class="line">cardParams.cvc = <span class="string">"123"</span></span><br><span class="line"></span><br><span class="line"><span class="type">STPAPIClient</span>.shared().createToken(withCard: cardParams) &#123; (token: <span class="type">STPToken?</span>, error: <span class="type">Error?</span>) <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> token = token, error == <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Present error to user...</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    submitTokenToBackend(token, completion: &#123; (error: <span class="type">Error?</span>) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">            <span class="comment">// Present error to user...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Continue with payment...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Payment-options-and-shipping-view-controllers"><a href="#Payment-options-and-shipping-view-controllers" class="headerlink" title="Payment options and shipping view controllers"></a>Payment options and shipping view controllers</h2><p>Instead of using <code>paymentContext</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">paymentContext.pushShippingViewController()</span><br><span class="line">paymentContext.pushPaymentOptionsViewController()</span><br></pre></td></tr></table></figure>

<p>We can use view controllers <a href="https://stripe.com/docs/mobile/ios/custom#stppaymentoptionsviewcontroller" target="_blank" rel="noopener">https://stripe.com/docs/mobile/ios/custom#stppaymentoptionsviewcontroller</a> directly with <code>STPPaymentOptionsViewController</code> and <code>STPShippingAddressViewController</code>. Then implement <code>STPPaymentOptionsViewControllerDelegate</code> and <code>STPShippingAddressViewControllerDelegate</code></p>
<h2 id="Register-merchant-Id-and-Apple-Pay-certificate"><a href="#Register-merchant-Id-and-Apple-Pay-certificate" class="headerlink" title="Register merchant Id and Apple Pay certificate"></a>Register merchant Id and Apple Pay certificate</h2><p><a href="https://stripe.com/docs/apple-pay/apps" target="_blank" rel="noopener">https://stripe.com/docs/apple-pay/apps</a></p>
<p>Get Certificate signing request file from Stripe <a href="https://dashboard.stripe.com/account/apple_pay" target="_blank" rel="noopener">https://dashboard.stripe.com/account/apple_pay</a></p>
<p>We can’t register merchant id with Enterprise account</p>
<h2 id="Use-Apple-Pay"><a href="#Use-Apple-Pay" class="headerlink" title="Use Apple Pay"></a>Use Apple Pay</h2><h3 id="Go-backend"><a href="#Go-backend" class="headerlink" title="Go backend"></a>Go backend</h3><p>Use token</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ApplePayRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">    Token <span class="keyword">string</span> <span class="string">`json:"token"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleChargeUsingApplePay</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	decoder := json.NewDecoder(r.Body)</span><br><span class="line">    <span class="keyword">var</span> t ApplePayRequest</span><br><span class="line">    err := decoder.Decode(&amp;t)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    params := &amp;stripe.ChargeParams&#123;</span><br><span class="line">        Amount:      stripe.Int64(<span class="number">150</span>),</span><br><span class="line">        Currency:    stripe.String(<span class="keyword">string</span>(stripe.CurrencyUSD)),</span><br><span class="line">		Description: stripe.String(<span class="string">"Charge from my Go backend for Apple Pay"</span>),</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">	params.SetSource(t.Token)</span><br><span class="line">    ch, err := charge.New(params)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"Could not process payment: %v"</span>, err)</span><br><span class="line">		fmt.Println(ch)</span><br><span class="line">		w.WriteHeader(<span class="number">400</span>)</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	w.WriteHeader(<span class="number">200</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="iOS-client-2"><a href="#iOS-client-2" class="headerlink" title="iOS client"></a>iOS client</h3><p>Update client to send <code>STPToken</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentClient</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> client = <span class="type">NetworkClient</span>(baseUrl: <span class="type">URL</span>(string: <span class="string">"localhost:8080"</span>)!)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">requestCharge</span><span class="params">(token: STPToken, completion: @escaping <span class="params">(Result&lt;<span class="params">()</span></span></span></span>, <span class="type">Error</span>&gt;) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> options = <span class="type">Options</span>()</span><br><span class="line">        options.httpMethod = .post</span><br><span class="line">        options.path = <span class="string">"request_charge_apple_pay"</span></span><br><span class="line">        options.parameters = [</span><br><span class="line">            <span class="string">"token"</span>: token.tokenId</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        client.make(options: options, completion: &#123; result <span class="keyword">in</span></span><br><span class="line">            completion(result.<span class="built_in">map</span>(&#123; <span class="number">_</span> <span class="keyword">in</span> () &#125;))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">useApplePay</span><span class="params">(payment: PKPayment, completion: @escaping <span class="params">(Result&lt;<span class="params">()</span></span></span></span>, <span class="type">Error</span>&gt;) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="type">STPAPIClient</span>.shared().createToken(with: payment, completion: &#123; (token: <span class="type">STPToken?</span>, error: <span class="type">Error?</span>) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> token = token, error == <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">self</span>.requestCharge(token: token, completion: completion)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Use <code>PKPaymentAuthorizationViewController</code>, not <code>PKPaymentAuthorizationController</code></p>
<p><a href="https://developer.apple.com/documentation/passkit/pkpaymentauthorizationcontroller" target="_blank" rel="noopener">https://developer.apple.com/documentation/passkit/pkpaymentauthorizationcontroller</a></p>
<blockquote>
<p>The PKPaymentAuthorizationController class performs the same role as the PKPaymentAuthorizationViewController class, but it does not depend on the UIKit framework. This means that the authorization controller can be used in places where a view controller cannot (for example, in watchOS apps or in SiriKit extensions).</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MainController</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">showApplePay</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> merchantId = <span class="string">"merchant.com.onmyway133.MyApp"</span></span><br><span class="line">        <span class="keyword">let</span> paymentRequest = <span class="type">Stripe</span>.paymentRequest(withMerchantIdentifier: merchantId, country: <span class="string">"US"</span>, currency: <span class="string">"USD"</span>)</span><br><span class="line">        paymentRequest.paymentSummaryItems = [</span><br><span class="line">            <span class="type">PKPaymentSummaryItem</span>(label: <span class="string">"Rubber duck"</span>, amount: <span class="number">1.5</span>)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="type">Stripe</span>.canSubmitPaymentRequest(paymentRequest) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">assertionFailure</span>()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> authorizationViewController = <span class="type">PKPaymentAuthorizationViewController</span>(paymentRequest: paymentRequest) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">assertionFailure</span>()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        authorizationViewController.delegate = <span class="keyword">self</span></span><br><span class="line">        innerNavigationController.present(authorizationViewController, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MainController</span>: <span class="title">PKPaymentAuthorizationViewControllerDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">paymentAuthorizationViewControllerDidFinish</span><span class="params">(<span class="number">_</span> controller: PKPaymentAuthorizationViewController)</span></span> &#123;</span><br><span class="line">        controller.dismiss(animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">paymentAuthorizationViewController</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="number">_</span> controller: PKPaymentAuthorizationViewController,</span></span></span><br><span class="line"><span class="function"><span class="params">        didAuthorizePayment payment: PKPayment,</span></span></span><br><span class="line"><span class="function"><span class="params">        handler completion: @escaping <span class="params">(PKPaymentAuthorizationResult)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line"></span><br><span class="line">        client.useApplePay(payment: payment, completion: &#123; result <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">switch</span> result &#123;</span><br><span class="line">            <span class="keyword">case</span> .success:</span><br><span class="line">                completion(.<span class="keyword">init</span>(status: .success, errors: <span class="literal">nil</span>))</span><br><span class="line">            <span class="keyword">case</span> .failure(<span class="keyword">let</span> error):</span><br><span class="line">                completion(.<span class="keyword">init</span>(status: .failure, errors: [error]))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Showing-Apple-Pay-option"><a href="#Showing-Apple-Pay-option" class="headerlink" title="Showing Apple Pay option"></a>Showing Apple Pay option</h2><p>From <code>appleMerchantIdentifier</code></p>
<blockquote>
<p>The Apple Merchant Identifier to use during Apple Pay transactions. To create one of these, see our guide at <a href="https://stripe.com/docs/mobile/apple-pay" target="_blank" rel="noopener">https://stripe.com/docs/mobile/apple-pay</a> . You must set this to a valid identifier in order to automatically enable Apple Pay.</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="type">Stripe</span>.deviceSupportsApplePay() &#123;</span><br><span class="line">    <span class="type">STPPaymentConfiguration</span>.shared().appleMerchantIdentifier = <span class="string">"merchant.com.onmyway133.MyApp"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">paymentContext.pushPaymentOptionsViewController()</span><br></pre></td></tr></table></figure>

<h2 id="requestPayment-not-showing-UI"><a href="#requestPayment-not-showing-UI" class="headerlink" title="requestPayment not showing UI"></a>requestPayment not showing UI</h2><p>From <code>requestPayment</code></p>
<blockquote>
<p>Requests payment from the user. This may need to present some supplemental UI to the user, in which case it will be presented on the payment context’s <code>hostViewController</code>. For instance, if they’ve selected Apple Pay as their payment method, calling this method will show the payment sheet. If the user has a card on file, this will use that without presenting any additional UI. After this is called, the <code>paymentContext:didCreatePaymentResult:completion:</code> and <code>paymentContext:didFinishWithStatus:error:</code> methods will be called on the context’s <code>delegate</code>.</p>
</blockquote>
<p>Use <code>STPPaymentOptionsViewController</code> to show cards and Apple Pay options</p>
<p>Code for <code>requestPayment</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)requestPayment &#123;</span><br><span class="line">    WEAK(<span class="keyword">self</span>);</span><br><span class="line">    [[[<span class="keyword">self</span>.didAppearPromise voidFlatMap:^STPPromise * _Nonnull&#123;</span><br><span class="line">        STRONG(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.loadingPromise;</span><br><span class="line">    &#125;] onSuccess:^(__unused STPPaymentOptionTuple *tuple) &#123;</span><br><span class="line">        STRONG(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.state != STPPaymentContextStateNone) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.selectedPaymentOption) &#123;</span><br><span class="line">            [<span class="keyword">self</span> presentPaymentOptionsViewControllerWithNewState:STPPaymentContextStateRequestingPayment];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span> requestPaymentShouldPresentShippingViewController]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> presentShippingViewControllerWithNewState:STPPaymentContextStateRequestingPayment];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.selectedPaymentOption isKindOfClass:[STPCard <span class="keyword">class</span>]] ||</span><br><span class="line">                 [<span class="keyword">self</span>.selectedPaymentOption isKindOfClass:[STPSource <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="keyword">self</span>.state = STPPaymentContextStateRequestingPayment;</span><br><span class="line">            STPPaymentResult *result = [[STPPaymentResult alloc] initWithSource:(<span class="keyword">id</span>&lt;STPSourceProtocol&gt;)<span class="keyword">self</span>.selectedPaymentOption];</span><br><span class="line">            [<span class="keyword">self</span>.delegate paymentContext:<span class="keyword">self</span> didCreatePaymentResult:result completion:^(<span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">                stpDispatchToMainThreadIfNecessary(^&#123;</span><br><span class="line">                    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                        [<span class="keyword">self</span> didFinishWithStatus:STPPaymentStatusError error:error];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        [<span class="keyword">self</span> didFinishWithStatus:STPPaymentStatusSuccess error:<span class="literal">nil</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.selectedPaymentOption isKindOfClass:[STPApplePayPaymentOption <span class="keyword">class</span>]]) &#123;</span><br><span class="line">      <span class="comment">// ....</span></span><br></pre></td></tr></table></figure>

<h2 id="Payment-options"><a href="#Payment-options" class="headerlink" title="Payment options"></a>Payment options</h2><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">paymentOptionsViewController</span><span class="params">(<span class="number">_</span> paymentOptionsViewController: STPPaymentOptionsViewController, didSelect paymentOption: STPPaymentOption)</span></span> &#123;</span><br><span class="line">	<span class="comment">// No op</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After user selects payment option, the change is saved in dashboard <code>https://dashboard.stripe.com/test/customers</code>, but for card only. Select Apple Pay does not reflect change in web dashboard.</p>
<p>Apple pay option is added manually locally, from <code>STPCustomer+SourceTuple.m</code> 😲</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (STPPaymentOptionTuple *)filteredSourceTupleForUIWithConfiguration:(STPPaymentConfiguration *)configuration &#123;</span><br><span class="line">    <span class="keyword">id</span>&lt;STPPaymentOption&gt; _Nullable selectedMethod = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableArray</span>&lt;<span class="keyword">id</span>&lt;STPPaymentOption&gt;&gt; *methods = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span>&lt;STPSourceProtocol&gt; customerSource <span class="keyword">in</span> <span class="keyword">self</span>.sources) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([customerSource isKindOfClass:[STPCard <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            STPCard *card = (STPCard *)customerSource;</span><br><span class="line">            [methods addObject:card];</span><br><span class="line">            <span class="keyword">if</span> ([card.stripeID isEqualToString:<span class="keyword">self</span>.defaultSource.stripeID]) &#123;</span><br><span class="line">                selectedMethod = card;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ([customerSource isKindOfClass:[STPSource <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            STPSource *source = (STPSource *)customerSource;</span><br><span class="line">            <span class="keyword">if</span> (source.type == STPSourceTypeCard</span><br><span class="line">                &amp;&amp; source.cardDetails != <span class="literal">nil</span>) &#123;</span><br><span class="line">                [methods addObject:source];</span><br><span class="line">                <span class="keyword">if</span> ([source.stripeID isEqualToString:<span class="keyword">self</span>.defaultSource.stripeID]) &#123;</span><br><span class="line">                    selectedMethod = source;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [STPPaymentOptionTuple tupleWithPaymentOptions:methods</span><br><span class="line">                                    selectedPaymentOption:selectedMethod</span><br><span class="line">                                        addApplePayOption:configuration.applePayEnabled];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>STPApplePayPaymentOption<code>is not available in</code>paymentContext.paymentOptions` immediately</p>
<h2 id="Change-selected-payment-option"><a href="#Change-selected-payment-option" class="headerlink" title="Change selected payment option"></a>Change selected payment option</h2><p>In <code>STPPaymentContext</code></p>
<p><code>setSelectedPaymentOption</code> is read only and trigger <code>paymentContextDidChange</code>, but it checks if <code>the new selected payment option</code> is equal to existing selected payment option</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setSelectedPaymentOption:(<span class="keyword">id</span>&lt;STPPaymentOption&gt;)selectedPaymentOption &#123;</span><br><span class="line">    <span class="keyword">if</span> (selectedPaymentOption &amp;&amp; ![<span class="keyword">self</span>.paymentOptions containsObject:selectedPaymentOption]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.paymentOptions = [<span class="keyword">self</span>.paymentOptions arrayByAddingObject:selectedPaymentOption];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (![_selectedPaymentOption isEqual:selectedPaymentOption]) &#123;</span><br><span class="line">        _selectedPaymentOption = selectedPaymentOption;</span><br><span class="line">        stpDispatchToMainThreadIfNecessary(^&#123;</span><br><span class="line">            [<span class="keyword">self</span>.delegate paymentContextDidChange:<span class="keyword">self</span>];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There is <code>retryLoading</code> which is called at <code>init</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)retryLoading &#123;</span><br><span class="line">    <span class="comment">// Clear any cached customer object before refetching</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.apiAdapter isKindOfClass:[STPCustomerContext <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        STPCustomerContext *customerContext = (STPCustomerContext *)<span class="keyword">self</span>.apiAdapter;</span><br><span class="line">        [customerContext clearCachedCustomer];</span><br><span class="line">    &#125;</span><br><span class="line">    WEAK(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">self</span>.loadingPromise = [[[STPPromise&lt;STPPaymentOptionTuple *&gt; new] onSuccess:^(STPPaymentOptionTuple *tuple) &#123;</span><br><span class="line">        STRONG(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">self</span>.paymentOptions = tuple.paymentOptions;</span><br><span class="line">        <span class="keyword">self</span>.selectedPaymentOption = tuple.selectedPaymentOption;</span><br><span class="line">    &#125;] onFailure:^(<span class="built_in">NSError</span> * _Nonnull error) &#123;</span><br><span class="line">        STRONG(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.hostViewController) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.didAppearPromise onSuccess:^(__unused <span class="keyword">id</span> value) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.paymentOptionsViewController) &#123;</span><br><span class="line">                    [<span class="keyword">self</span> appropriatelyDismissPaymentOptionsViewController:<span class="keyword">self</span>.paymentOptionsViewController completion:^&#123;</span><br><span class="line">                        [<span class="keyword">self</span>.delegate paymentContext:<span class="keyword">self</span> didFailToLoadWithError:error];</span><br><span class="line">                    &#125;];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    [<span class="keyword">self</span>.delegate paymentContext:<span class="keyword">self</span> didFailToLoadWithError:error];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    [<span class="keyword">self</span>.apiAdapter retrieveCustomer:^(STPCustomer * _Nullable customer, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        stpDispatchToMainThreadIfNecessary(^&#123;</span><br><span class="line">            STRONG(<span class="keyword">self</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                [<span class="keyword">self</span>.loadingPromise fail:error];</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">self</span>.shippingAddress &amp;&amp; customer.shippingAddress) &#123;</span><br><span class="line">                <span class="keyword">self</span>.shippingAddress = customer.shippingAddress;</span><br><span class="line">                <span class="keyword">self</span>.shippingAddressNeedsVerification = <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            STPPaymentOptionTuple *paymentTuple = [customer filteredSourceTupleForUIWithConfiguration:<span class="keyword">self</span>.configuration];</span><br><span class="line"></span><br><span class="line">            [<span class="keyword">self</span>.loadingPromise succeed:paymentTuple];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Which in turns call <code>STPCustomerEphemeralKeyProvider</code>. As stripe does not save Apple Pay option in dashboard, this method return list of card payment options, together with the default card as selected payment option 😲</p>
<p>Although the new <code>STPCard</code> has a different address, it is the exact same card with the same info, and the <code>isEqual</code> method of <code>STPCard</code> is</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)isEqualToCard:(<span class="keyword">nullable</span> STPCard *)other &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> == other) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!other || ![other isKindOfClass:<span class="keyword">self</span>.class]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.stripeID isEqualToString:other.stripeID];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I raised an issue <a href="https://github.com/stripe/stripe-ios/issues/1175" target="_blank" rel="noopener">How to change selected payment option?</a> hope it gets resolved soon 😢</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/speaking/">Speaking</a></li>
         
          <li><a href="/opensource/">Open Source</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Show-basic-add-card-in-iOS"><span class="toc-number">1.</span> <span class="toc-text">Show basic add card in iOS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generate-ephemeral-key"><span class="toc-number">2.</span> <span class="toc-text">Generate ephemeral key</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backend-in-Go"><span class="toc-number">2.1.</span> <span class="toc-text">Backend in Go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS-client"><span class="toc-number">2.2.</span> <span class="toc-text">iOS client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handle-charge"><span class="toc-number">3.</span> <span class="toc-text">Handle charge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Backend-in-Go-1"><span class="toc-number">3.1.</span> <span class="toc-text">Backend in Go</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS-client-1"><span class="toc-number">3.2.</span> <span class="toc-text">iOS client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Token-from-card"><span class="toc-number">4.</span> <span class="toc-text">Token from card</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payment-options-and-shipping-view-controllers"><span class="toc-number">5.</span> <span class="toc-text">Payment options and shipping view controllers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Register-merchant-Id-and-Apple-Pay-certificate"><span class="toc-number">6.</span> <span class="toc-text">Register merchant Id and Apple Pay certificate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Use-Apple-Pay"><span class="toc-number">7.</span> <span class="toc-text">Use Apple Pay</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Go-backend"><span class="toc-number">7.1.</span> <span class="toc-text">Go backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS-client-2"><span class="toc-number">7.2.</span> <span class="toc-text">iOS client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Showing-Apple-Pay-option"><span class="toc-number">8.</span> <span class="toc-text">Showing Apple Pay option</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#requestPayment-not-showing-UI"><span class="toc-number">9.</span> <span class="toc-text">requestPayment not showing UI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payment-options"><span class="toc-number">10.</span> <span class="toc-text">Payment options</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Change-selected-payment-option"><span class="toc-number">11.</span> <span class="toc-text">Change selected payment option</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&text=How to use Stripe and Apple Pay in iOS"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&is_video=false&description=How to use Stripe and Apple Pay in iOS"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=How to use Stripe and Apple Pay in iOS&body=Check out this article: https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&title=How to use Stripe and Apple Pay in iOS"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://onmyway133.github.io/How-to-use-Stripe-and-Apple-Pay-in-iOS/&name=How to use Stripe and Apple Pay in iOS&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Khoa Pham
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/speaking/">Speaking</a></li>
         
          <li><a href="/opensource/">Open Source</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-40119591-5', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
